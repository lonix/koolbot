name: Build and MongoDB Connection Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create .env file for testing
        run: |
          cat > .env << EOF
          MONGODB_URI=mongodb://mongodb:27017/koolbot
          NODE_ENV=development
          EOF

      - name: Start MongoDB service with docker-compose.dev.yml
        run: |
          docker-compose -f docker-compose.dev.yml up -d mongodb
          echo "MongoDB service started, waiting for initialization..."

      - name: Wait for MongoDB to be ready
        run: |
          echo "Waiting for MongoDB to be ready..."
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if docker exec koolbot-mongodb-dev mongosh --eval "db.adminCommand('ping')" > /dev/null 2>&1; then
              echo "MongoDB is ready!"
              break
            fi
            echo "Waiting for MongoDB... ($elapsed seconds elapsed)"
            sleep 2
            elapsed=$((elapsed + 2))
          done
          if [ $elapsed -ge $timeout ]; then
            echo "MongoDB failed to start within $timeout seconds"
            docker logs koolbot-mongodb-dev
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript build test
        run: |
          echo "=== Testing TypeScript Build ==="
          npm run build
          echo "✓ Build completed successfully"
          ls -lh dist/index.js
          echo "✓ Build artifacts created"

      - name: Test MongoDB connection
        run: |
          echo "=== Testing MongoDB Connection ==="
          node --import ./src/loader.js src/scripts/test-mongodb-connection.ts

      - name: Display MongoDB logs on failure
        if: failure()
        run: |
          echo "=== MongoDB Container Logs ==="
          docker logs koolbot-mongodb-dev
          echo ""
          echo "=== Docker Compose Status ==="
          docker-compose -f docker-compose.dev.yml ps

      - name: Cleanup
        if: always()
        run: |
          echo "Stopping and removing containers..."
          docker-compose -f docker-compose.dev.yml down -v
          echo "Cleanup complete"
